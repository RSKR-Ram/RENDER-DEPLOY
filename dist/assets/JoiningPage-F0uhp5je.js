import{a as W,r as y,j as t,A as B,S as v,M as q,a7 as z,n as r,a8 as K,a9 as G,aa as V,ab as Y}from"./index-Dn7xk2-6.js";import{C as Q}from"./Collapsible-BtIsWir-.js";import{v as X}from"./scheduling-mgpGDE0C.js";import{o as Z}from"./files-Tp243tmQ.js";function ee(n){if(!n)return"";const o=n instanceof Date?n:new Date(n);if(Number.isNaN(o.getTime()))return"";const m=u=>String(u).padStart(2,"0"),l=o.getFullYear(),g=m(o.getMonth()+1),h=m(o.getDate()),c=m(o.getHours()),N=m(o.getMinutes());return`${l}-${g}-${h}T${c}:${N}`}function te(n){if(!n)return"-";const o=n instanceof Date?n:new Date(n);return Number.isNaN(o.getTime())?String(n):o.toLocaleString()}function ae(n){if(!Number.isFinite(n))return"-";const o=n<0?"-":"",m=Math.abs(n),l=Math.floor(m/1e3),g=Math.floor(l/(3600*24)),h=Math.floor(l%(3600*24)/3600),c=Math.floor(l%3600/60),N=l%60,u=[];return g&&u.push(`${g}d`),u.push(`${String(h).padStart(2,"0")}h`),u.push(`${String(c).padStart(2,"0")}m`),u.push(`${String(N).padStart(2,"0")}s`),`${o}${u.join(" ")}`}async function ne(n){return new Promise((o,m)=>{const l=new FileReader;l.onload=()=>{const g=String(l.result||""),h=g.indexOf(",");if(h===-1){m(new Error("Invalid file encoding"));return}o(g.slice(h+1))},l.onerror=()=>m(new Error("Failed to read file")),l.readAsDataURL(n)})}function de(){const{token:n,role:o,legacyRole:m,canPortal:l,canAction:g}=W();function h(e,i){const a=typeof l=="function"?l(e):null;if(a===!0||a===!1)return a;const s=String(m||o||"").toUpperCase();return Array.isArray(i)?i.includes(s):!1}function c(e,i){const a=typeof g=="function"?g(e):null;if(a===!0||a===!1)return a;const s=String(m||o||"").toUpperCase();return Array.isArray(i)?i.includes(s):!1}const N=h("PORTAL_HR_JOINING",["HR","ADMIN"]),[u,A]=y.useState(!1),[S,R]=y.useState([]),[x,j]=y.useState(""),[w,T]=y.useState({}),[C,k]=y.useState({}),[_,E]=y.useState(Date.now());async function D(){if(N&&c("JOINING_LIST",["HR","ADMIN"])){A(!0);try{const i=(await z(n)).items||[];R(i),T(a=>{const s={...a};return i.forEach(d=>{s[d.candidateId]||(s[d.candidateId]={joiningAt:ee(d.joiningAt),remark:""})}),s})}catch(e){r.error((e==null?void 0:e.message)||"Failed to load")}finally{A(!1)}}}y.useEffect(()=>{D()},[N]),y.useEffect(()=>{const e=setInterval(()=>E(Date.now()),1e3);return()=>clearInterval(e)},[]);const M=y.useMemo(()=>S.length,[S]);async function J(e){if(!c("JOINING_SET_DATE",["HR","ADMIN"])){r.error("Not allowed");return}const i=w[e.candidateId]||{},a=String(i.joiningAt||"").trim();if(!a){r.error("Select joining date/time");return}const s=X(a);if(!s.ok){r.error(s.message);return}const d=s.date,p=`${e.candidateId}:SET_DATE`;j(p);try{await K(n,{requirementId:e.requirementId,candidateId:e.candidateId,joiningAt:d.toISOString()}),r.success("Joining date set"),await D()}catch(f){r.error((f==null?void 0:f.message)||"Failed")}finally{j("")}}async function $(e){if(!c("DOCS_UPLOAD",["HR","ADMIN"])){r.error("Not allowed");return}const i=C[e.candidateId]||[];if(!i.length){r.error("Select documents first");return}const a=`${e.candidateId}:DOCS_UPLOAD`;j(a);try{const s=[];for(let d=0;d<i.length;d+=1){const p=i[d],f=await ne(p);s.push({filename:p.name,mimeType:p.type||"application/octet-stream",base64:f,docType:""})}await G(n,{requirementId:e.requirementId,candidateId:e.candidateId,docs:s}),r.success("Docs uploaded"),k(d=>({...d,[e.candidateId]:[]})),await D()}catch(s){r.error((s==null?void 0:s.message)||"Upload failed")}finally{j("")}}async function P(e){if(!c("DOCS_COMPLETE",["HR","ADMIN"])){r.error("Not allowed");return}const i=`${e.candidateId}:DOCS_COMPLETE`;j(i);try{await V(n,{requirementId:e.requirementId,candidateId:e.candidateId}),r.success("Docs marked complete"),await D()}catch(a){r.error((a==null?void 0:a.message)||"Failed")}finally{j("")}}async function U(e){if(!c("MARK_JOIN",["HR","ADMIN"])){r.error("Not allowed");return}const i=`${e.candidateId}:MARK_JOIN`;j(i);try{await Y(n,{requirementId:e.requirementId,candidateId:e.candidateId,remark:""}),r.success("Marked joined"),await D()}catch(a){r.error((a==null?void 0:a.message)||"Failed")}finally{j("")}}function F(e){if(!e)return;Z(e,n)||r.error("Unable to open file")}return t.jsxs(B,{children:[N?null:t.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[t.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),t.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You don‚Äôt have access to Joining portal."})]}),t.jsxs("div",{style:{marginBottom:"20px"},children:[t.jsx("h1",{className:"page-title",children:"Joining"}),t.jsx("p",{className:"page-subtitle",children:"Manage candidate joining process and documentation"})]}),t.jsx("div",{className:"card",style:{marginBottom:"16px"},children:t.jsxs("div",{className:"row",style:{gap:12,alignItems:"flex-end",flexWrap:"wrap"},children:[t.jsxs("button",{className:"button",onClick:D,disabled:u,style:{display:"flex",alignItems:"center",gap:6},children:[u?t.jsx(v,{size:14}):null,"Refresh"]}),t.jsx("div",{style:{marginLeft:"auto"},children:t.jsxs("span",{className:"badge",children:[M," candidates"]})})]})}),u?t.jsx(q,{text:"Loading candidates..."}):t.jsx(Q,{title:"Joining Candidates",subtitle:"Set joining date, upload docs, and mark joined",badge:M,variant:"card",defaultOpen:!0,children:S.length===0?t.jsxs("div",{className:"empty-state",children:[t.jsx("div",{className:"empty-state-icon",children:"üéâ"}),t.jsx("div",{className:"empty-state-text",children:"No candidates in Joining"})]}):t.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:12},children:S.map(e=>{const i=String(e.status||"").toUpperCase(),a=i==="JOINING",s=!!e.docsCompleteAt,d=Array.isArray(e.docs)&&e.docs.length>0,p=e.joiningAt?new Date(e.joiningAt):null,f=p&&!Number.isNaN(p.getTime())?p.getTime()-_:null,O=w[e.candidateId]||{joiningAt:"",remark:""},L=C[e.candidateId]||[];return t.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:t.jsxs("div",{style:{display:"grid",gap:16},children:[t.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:12,flexWrap:"wrap"},children:[t.jsxs("div",{style:{flex:1,minWidth:240},children:[t.jsx("div",{style:{fontWeight:700,fontSize:"16px"},children:e.candidateName}),t.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} ¬∑ `:"",e.jobRole," ¬∑ ",e.mobile]}),t.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[t.jsxs("span",{className:"badge",children:["Req: ",e.requirementId]}),t.jsx("span",{className:"badge",style:{background:"var(--primary)",color:"#fff"},children:i})]})]}),t.jsxs("div",{style:{textAlign:"right"},children:[t.jsx("div",{className:"small",style:{color:"var(--gray-500)"},children:"Joining Date"}),t.jsx("div",{style:{fontWeight:700,fontSize:"15px",marginTop:2},children:e.joiningAt?te(e.joiningAt):"Not set"}),f!=null&&t.jsx("div",{style:{marginTop:4},children:t.jsxs("span",{className:"badge",style:{background:f<0?"#ef4444":"#22c55e",color:"#fff",fontFamily:"monospace"},children:["‚è± ",ae(f)]})})]})]}),t.jsxs("div",{style:{padding:"12px",background:"var(--gray-50)",borderRadius:"var(--radius)"},children:[t.jsx("div",{className:"small",style:{fontWeight:700,marginBottom:8},children:"üìÖ Set Joining Date"}),t.jsxs("div",{className:"row",style:{gap:8,flexWrap:"wrap",alignItems:"flex-end"},children:[t.jsx("input",{type:"datetime-local",value:O.joiningAt,onChange:I=>T(b=>({...b,[e.candidateId]:{...O,joiningAt:I.target.value}})),style:{flex:1,minWidth:200}}),t.jsxs("button",{className:"button primary",type:"button",onClick:()=>J(e),disabled:!!x||!c("JOINING_SET_DATE",["HR","ADMIN"]),children:[x===`${e.candidateId}:SET_DATE`?t.jsx(v,{size:14}):null,"Set Date"]})]})]}),t.jsxs("div",{style:{padding:"12px",background:"var(--gray-50)",borderRadius:"var(--radius)"},children:[t.jsxs("div",{className:"small",style:{fontWeight:700,marginBottom:8},children:["üìÑ Docs Verification",d&&t.jsxs("span",{className:"badge",style:{marginLeft:8},children:[e.docs.length," uploaded"]}),s&&t.jsx("span",{className:"badge",style:{marginLeft:8,background:"#22c55e",color:"#fff"},children:"‚úì Complete"})]}),d&&t.jsx("div",{style:{marginBottom:10,display:"flex",gap:6,flexWrap:"wrap"},children:e.docs.slice(0,5).map((I,b)=>t.jsxs("button",{className:"button",type:"button",onClick:()=>F(I.fileId),style:{fontSize:"12px",padding:"4px 8px"},children:["üìÑ Doc ",b+1]},`${e.candidateId}:doc:${b}`))}),t.jsx("input",{type:"file",multiple:!0,disabled:!c("DOCS_UPLOAD",["HR","ADMIN"]),onChange:I=>{const b=Array.from(I.target.files||[]);k(H=>({...H,[e.candidateId]:b}))},style:{marginBottom:8}}),L.length>0&&t.jsxs("div",{className:"small",style:{marginBottom:8,color:"var(--gray-600)"},children:["Selected: ",L.map(I=>I.name).join(", ")]}),t.jsxs("div",{className:"action-grid",children:[t.jsxs("button",{className:"button",type:"button",onClick:()=>$(e),disabled:!!x||!c("DOCS_UPLOAD",["HR","ADMIN"]),children:[x===`${e.candidateId}:DOCS_UPLOAD`?t.jsx(v,{size:14}):null,"Upload Docs"]}),t.jsxs("button",{className:"button",type:"button",onClick:()=>P(e),disabled:!d||!!x||!c("DOCS_COMPLETE",["HR","ADMIN"]),children:[x===`${e.candidateId}:DOCS_COMPLETE`?t.jsx(v,{size:14}):null,"Docs Complete"]})]})]}),t.jsxs("div",{style:{padding:"12px",background:a&&s?"#dcfce7":"var(--gray-50)",borderRadius:"var(--radius)"},children:[t.jsx("div",{className:"small",style:{fontWeight:700,marginBottom:8},children:"üéâ Mark Join"}),t.jsxs("button",{className:"button primary",type:"button",onClick:()=>U(e),disabled:!a||!s||!!x||!c("MARK_JOIN",["HR","ADMIN"]),style:{width:"100%"},children:[x===`${e.candidateId}:MARK_JOIN`?t.jsx(v,{size:14}):null,"Mark Joined"]}),!a&&t.jsx("div",{className:"small",style:{marginTop:6,color:"var(--gray-500)"},children:"‚ö†Ô∏è Locked until joining date is set"}),a&&!s&&t.jsx("div",{className:"small",style:{marginTop:6,color:"var(--gray-500)"},children:"‚ö†Ô∏è Locked until docs complete"})]})]})},e.candidateId)})})})]})}export{de as JoiningPage};
