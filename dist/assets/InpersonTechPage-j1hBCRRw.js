import{a as G,r as d,j as s,A as Q,Y as H,n as l,U as X,S as E,M as ee,Z as se,_ as ae,$ as te}from"./index-Dn7xk2-6.js";import{C as L}from"./Collapsible-BtIsWir-.js";function $(c){if(!c)return"";const h=c instanceof Date?c:new Date(c);return Number.isNaN(h.getTime())?String(c):h.toLocaleString()}function ie(){const{token:c,role:h,legacyRole:D,canPortal:q,canAction:O}=G();function K(e,a){const t=typeof q=="function"?q(e):null;if(t===!0||t===!1)return t;const n=String(D||h||"").toUpperCase();return Array.isArray(a)?a.includes(n):!1}function g(e,a){const t=typeof O=="function"?O(e):null;if(t===!0||t===!1)return t;const n=String(D||h||"").toUpperCase();return Array.isArray(a)?a.includes(n):!1}const k=K("PORTAL_HR_INPERSON",["HR","ADMIN"]),[R,W]=d.useState(!1),[o,U]=d.useState("ALL"),[f,M]=d.useState([]),[A,_]=d.useState({}),[N,F]=d.useState({}),[u,I]=d.useState(""),[i,y]=d.useState(null),[C,x]=d.useState("");function w(e,a){try{const t=JSON.parse(String((e==null?void 0:e.testDecisionsJson)||"{}")),n=t==null?void 0:t[a];return String((n==null?void 0:n.decision)||"").toUpperCase()==="CONTINUE"}catch{return!1}}const B=d.useMemo(()=>{const e=Array.from(new Set(f.map(a=>a.jobRole).filter(Boolean)));return e.sort((a,t)=>String(a).localeCompare(String(t))),["ALL",...e]},[f]);async function v(e){if(k&&g("INPERSON_PIPELINE_LIST",["HR","ADMIN"])){W(!0);try{const a=await se(c,{jobRole:e&&e!=="ALL"?e:""});M(a.items??[]);const t={},n={};for(const r of a.items??[])t[r.candidateId]=r.inPersonMarks??"",n[r.candidateId]=Array.isArray(r.techSelectedTests)?r.techSelectedTests:[];_(t),F(n)}catch(a){l.error((a==null?void 0:a.message)||"Failed to load")}finally{W(!1)}}}d.useEffect(()=>{v(o)},[o,k]);const j=d.useMemo(()=>o==="ALL"?f:f.filter(e=>e.jobRole===o),[f,o]),P=d.useMemo(()=>j.filter(e=>e.inPersonMarks===""||e.inPersonMarks==null),[j]),b=d.useMemo(()=>j.filter(e=>e.inPersonMarks!==""&&e.inPersonMarks!=null),[j]),S=d.useMemo(()=>b.filter(e=>{const a=Number(e.inPersonMarks);return!Number.isFinite(a)||a>=6?!1:!w(e,"INPERSON_MARKS")}),[b]);async function z(e){if(!g("INPERSON_MARKS_SAVE",["HR","ADMIN"])){l.error("Not allowed");return}const a=A[e.candidateId],t=Number(a);if(!Number.isFinite(t)){l.error("Enter marks (0-10)");return}const n=`${e.candidateId}:MARKS`;I(n);try{const r=await ae(c,{requirementId:e.requirementId,candidateId:e.candidateId,marks:t});if(r.decisionRequired&&String(r.passFail||"").toUpperCase()==="FAIL"){l.error("FAIL ‚Äî HR decision required"),y({requirementId:e.requirementId,candidateId:e.candidateId,candidateName:e.candidateName,testType:r.testType||"INPERSON_MARKS",stageTag:r.stageTag||"In-person Marks",marks:{inPersonMarks:t}}),x("");return}l.success("Marks saved"),M(m=>m.map(p=>p.candidateId===e.candidateId?{...p,inPersonMarks:t,inPersonMarksAt:new Date().toISOString()}:p))}catch(r){l.error((r==null?void 0:r.message)||"Failed")}finally{I("")}}function J(e,a){F(t=>{const n=Array.isArray(t[e])?t[e]:[],m=n.includes(a)?n.filter(p=>p!==a):[...n,a];return{...t,[e]:m}})}async function V(e){if(!g("TECH_SELECT",["HR","ADMIN"])){l.error("Not allowed");return}const a=`${e.candidateId}:TECH`;I(a);try{const t=N[e.candidateId]??[],n=await te(c,{requirementId:e.requirementId,candidateId:e.candidateId,tests:t});l.success("Tech tests saved"),M(r=>r.map(m=>m.candidateId===e.candidateId?{...m,techSelectedTests:n.tests??t,techSelectedAt:n.techSelectedAt}:m))}catch(t){l.error((t==null?void 0:t.message)||"Failed")}finally{I("")}}async function Y(e){const a=Array.isArray(N[e.candidateId])?N[e.candidateId]:e.techSelectedTests||[],t=[`Name: ${e.candidateName}`,`Mobile: ${e.mobile}`,`Role: ${e.jobRole}${e.jobTitle?` (${e.jobTitle})`:""}`,`Online Test: ${e.onlineTestResult} ${e.onlineTestScore!==""?`(${e.onlineTestScore}/10)`:""}`,`In-person Marks: ${A[e.candidateId]??e.inPersonMarks??""}`,`Technical Tests: ${a.join(", ")}`].join(`
`);try{await navigator.clipboard.writeText(t),l.success("Copied")}catch{l.error("Copy failed")}}const Z=()=>v(o);return s.jsxs(Q,{children:[i?s.jsxs("div",{className:"card",style:{marginBottom:12,border:"1px solid var(--gray-200)"},children:[s.jsx("div",{style:{fontWeight:800,marginBottom:6},children:"In-person FAIL ‚Äî HR decision required"}),s.jsxs("div",{className:"small",style:{color:"var(--gray-600)",marginBottom:10},children:[i.candidateName||i.candidateId," ¬∑ ",i.stageTag]}),s.jsx("div",{className:"small",style:{marginBottom:6,fontWeight:700},children:"Remark (required only if Reject)"}),s.jsx("textarea",{value:C,onChange:e=>x(e.target.value),rows:2,style:{width:"100%"}}),s.jsxs("div",{style:{display:"flex",gap:8,marginTop:10,flexWrap:"wrap"},children:[s.jsx("button",{className:"button",type:"button",onClick:async()=>{try{await H(c,{requirementId:i.requirementId,candidateId:i.candidateId,testType:i.testType,decision:"CONTINUE",remark:String(C||"").trim(),stageTag:i.stageTag,meta:{marks:i.marks}}),l.success("Override applied (Continued)"),y(null),x(""),await v(o)}catch(e){l.error((e==null?void 0:e.message)||"Failed")}},disabled:!!u,children:"Continue"}),s.jsx("button",{className:"button danger",type:"button",onClick:async()=>{const e=String(C||"").trim();if(!e){l.error("Remark is required to Reject");return}try{await H(c,{requirementId:i.requirementId,candidateId:i.candidateId,testType:i.testType,decision:"REJECT",remark:e,stageTag:i.stageTag,meta:{marks:i.marks}}),X({requirementId:i.requirementId,candidateId:i.candidateId}),l.success("Rejected"),y(null),x(""),await v(o)}catch(a){l.error((a==null?void 0:a.message)||"Failed")}},disabled:!!u,children:"Reject"}),s.jsx("button",{className:"button",type:"button",onClick:()=>y(null),disabled:!!u,children:"Close"})]})]}):null,k?null:s.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[s.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),s.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You don‚Äôt have access to In-person portal."})]}),s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsx("h1",{className:"page-title",children:"In-person Interview + Technical Selection"}),s.jsx("p",{className:"page-subtitle",children:"Shows candidates who passed the online test"})]}),s.jsxs("div",{className:"card",style:{marginBottom:"16px"},children:[s.jsxs("div",{className:"row",style:{gap:12,alignItems:"flex-end",flexWrap:"wrap"},children:[s.jsxs("button",{className:"button",onClick:Z,disabled:R,style:{display:"flex",alignItems:"center",gap:6},children:[R?s.jsx(E,{size:14}):null,"Refresh"]}),s.jsx("div",{style:{marginLeft:"auto"},children:s.jsxs("span",{className:"badge",children:[j.length," candidates"]})})]}),s.jsx("div",{style:{height:12}}),s.jsx("div",{className:"tabs",children:B.map(e=>s.jsx("button",{className:["tab",o===e?"active":""].join(" "),onClick:()=>U(e),type:"button",children:e},e))})]}),R?s.jsx(ee,{text:"Loading candidates..."}):s.jsxs(s.Fragment,{children:[s.jsx(L,{title:"In-person Marks FAIL (Decision Required)",subtitle:"Candidates with marks < 6 must be Continued/Rejected by HR",badge:S.length,variant:"card",defaultOpen:S.length>0,children:S.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("div",{className:"empty-state-icon",children:"‚úÖ"}),s.jsx("div",{className:"empty-state-text",children:"No pending decisions"})]}):s.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:S.map(e=>{const a=Number(e.inPersonMarks);return s.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:s.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flexWrap:"wrap"},children:[s.jsxs("div",{style:{minWidth:240},children:[s.jsx("div",{style:{fontWeight:700,fontSize:"15px"},children:e.candidateName}),s.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} ¬∑ `:"",e.jobRole," ¬∑ ",e.mobile]}),s.jsxs("div",{style:{marginTop:6,display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsxs("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:["In-person: ",e.inPersonMarks,"/10"]}),s.jsx("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:"Decision Required"})]})]}),s.jsx("div",{className:"action-grid",style:{marginLeft:"auto"},children:s.jsx("button",{className:"button",type:"button",onClick:()=>{y({requirementId:e.requirementId,candidateId:e.candidateId,candidateName:e.candidateName,testType:"INPERSON_MARKS",stageTag:"In-person Marks",marks:{inPersonMarks:Number.isFinite(a)?a:e.inPersonMarks}}),x("")},disabled:!!u||!g("TEST_FAIL_DECIDE",["HR","ADMIN"]),children:"Decide (Continue/Reject)"})})]})},e.candidateId)})})}),s.jsx("div",{style:{height:16}}),s.jsx(L,{title:"Pending In-person Marks",subtitle:"Candidates awaiting in-person interview marks",badge:P.length,variant:"card",defaultOpen:!0,children:P.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("div",{className:"empty-state-icon",children:"üìù"}),s.jsx("div",{className:"empty-state-text",children:"No candidates pending marks"})]}):s.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:P.map(e=>{const a=`${e.candidateId}:MARKS`;return s.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:s.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flexWrap:"wrap"},children:[s.jsxs("div",{style:{minWidth:240},children:[s.jsx("div",{style:{fontWeight:700,fontSize:"15px"},children:e.candidateName}),s.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} ¬∑ `:"",e.jobRole," ¬∑ ",e.mobile]}),s.jsxs("div",{style:{marginTop:6,display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsxs("span",{className:"badge",style:{background:String(e.onlineTestResult||"").toUpperCase()==="PASS"?"#22c55e":"#ef4444",color:"#fff"},children:["Online: ",String(e.onlineTestResult||"").toUpperCase()]}),String(e.onlineTestResult||"").toUpperCase()==="FAIL"&&w(e,"ONLINE_TEST")?s.jsx("span",{className:"badge",style:{background:"#f59e0b",color:"#fff"},children:"HR Override Applied"}):null,e.onlineTestScore!==""?s.jsxs("span",{className:"badge",children:["Score: ",e.onlineTestScore,"/10"]}):null]})]}),s.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",marginLeft:"auto"},children:[s.jsx("input",{style:{width:90},placeholder:"Marks",value:A[e.candidateId]??"",onChange:t=>_(n=>({...n,[e.candidateId]:t.target.value}))}),s.jsxs("button",{className:"button primary",type:"button",onClick:()=>z(e),disabled:!!u||!g("INPERSON_MARKS_SAVE",["HR","ADMIN"]),children:[u===a?s.jsx(E,{size:14}):null,"Save"]})]})]})},e.candidateId)})})}),s.jsx("div",{style:{height:16}}),s.jsx(L,{title:"Technical Selection (Marks ‚â• 6 or HR override)",subtitle:"Select technical tests for qualified candidates",badge:b.length,variant:"card",defaultOpen:!0,children:b.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("div",{className:"empty-state-icon",children:"‚öôÔ∏è"}),s.jsx("div",{className:"empty-state-text",children:"No candidates ready for technical selection"})]}):s.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:b.map(e=>{const a=Number(e.inPersonMarks),t=w(e,"INPERSON_MARKS"),n=Number.isFinite(a)&&a>=6||t,r=e.allowedTechTests??[],m=N[e.candidateId]??[],p=`${e.candidateId}:TECH`;return s.jsxs("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:[s.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:12,flexWrap:"wrap"},children:[s.jsxs("div",{style:{minWidth:240},children:[s.jsx("div",{style:{fontWeight:700,fontSize:"15px"},children:e.candidateName}),s.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} ¬∑ `:"",e.jobRole," ¬∑ ",e.mobile]}),s.jsxs("div",{style:{marginTop:6,display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsxs("span",{className:"badge",style:{background:a>=6?"#22c55e":"#ef4444",color:"#fff"},children:["In-person: ",e.inPersonMarks,"/10"]}),Number.isFinite(a)&&a<6?t?s.jsx("span",{className:"badge",style:{background:"#f59e0b",color:"#fff"},children:"HR Override Applied"}):s.jsx("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:"Decision Required"}):null,e.inPersonMarksAt?s.jsxs("span",{className:"badge",children:["üìÖ ",$(e.inPersonMarksAt)]}):null]})]}),s.jsx("div",{style:{marginLeft:"auto",display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"},children:s.jsx("button",{className:"button",type:"button",onClick:()=>Y(e),children:"üìã Copy"})})]}),n?s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{height:12}}),s.jsx("div",{className:"small",style:{fontWeight:600},children:"Select tests:"}),s.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",marginTop:8},children:r.map(T=>s.jsxs("label",{style:{display:"flex",gap:6,alignItems:"center",fontSize:"14px",cursor:"pointer"},children:[s.jsx("input",{type:"checkbox",checked:m.includes(T),onChange:()=>J(e.candidateId,T)}),T]},T))}),s.jsx("div",{style:{height:12}}),s.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flexWrap:"wrap"},children:[s.jsxs("button",{className:"button primary",type:"button",onClick:()=>V(e),disabled:!!u||!g("TECH_SELECT",["HR","ADMIN"]),children:[u===p?s.jsx(E,{size:14}):null,"Save Technical Tests"]}),e.techSelectedAt?s.jsxs("span",{className:"small",style:{color:"var(--gray-500)"},children:["‚úì Saved: ",$(e.techSelectedAt)]}):null]})]}):s.jsx("div",{style:{marginTop:12,padding:"10px 12px",background:"#fef3c7",borderRadius:"var(--radius)",fontSize:"13px"},children:"‚ö†Ô∏è Technical Test selection disabled (marks must be ‚â• 6 or HR override required)"})]},e.candidateId)})})})]})]})}export{ie as InpersonTechPage};
