import{a as K,r as u,j as a,A as X,Y as $,n as r,U as J,S as C,M as G,a0 as Y,a1 as Q,a2 as Z}from"./index-Dn7xk2-6.js";import{C as O}from"./Collapsible-BtIsWir-.js";function V(m){if(!m)return"";const y=m instanceof Date?m:new Date(m);return Number.isNaN(y.getTime())?String(m):y.toLocaleString()}function se(){const{token:m,role:y,canUi:F,canAction:M}=K(),w=(M&&M("EA_TECH_MARKS_SUBMIT"))??(y==="EA"||y==="ADMIN"),j=(F&&F("SECTION_EXCEL_MARKS"))??y==="ADMIN",h=(M&&M("ADMIN_EXCEL_MARKS_SUBMIT"))??y==="ADMIN",z=!!(j&&h),[L,U]=u.useState(!1),[B,q]=u.useState([]),[E,P]=u.useState({}),[o,R]=u.useState(""),[i,x]=u.useState(null),[W,p]=u.useState("");function A(e,s){try{const t=JSON.parse(String((e==null?void 0:e.testDecisionsJson)||"{}")),n=t==null?void 0:t[s];return String((n==null?void 0:n.decision)||"").toUpperCase()==="CONTINUE"}catch{return!1}}async function b(){U(!0);try{const s=(await Y(m)).items??[];q(s);const t={};for(const n of s)t[n.candidateId]={tallyMarks:n.tallyMarks??"",voiceMarks:n.voiceMarks??"",excelMarks:n.excelMarks??"",review:""};P(t)}catch(e){r.error((e==null?void 0:e.message)||"Failed to load")}finally{U(!1)}}u.useEffect(()=>{b()},[]);const v=u.useMemo(()=>B,[B]),S=u.useMemo(()=>v.filter(e=>String(e.techResult||"").toUpperCase()!=="FAIL"?!1:!A(e,"TECHNICAL")),[v]),D=u.useMemo(()=>v.filter(e=>String(e.techResult||"").toUpperCase()!=="FAIL"?!0:A(e,"TECHNICAL")),[v]);function g(e,s,t){P(n=>({...n,[e]:{...n[e]||{},[s]:t}}))}async function H(e){if(!w){r.error("Not allowed");return}const s=E[e.candidateId]||{},t=String(s.review||"").trim();if(!t){r.error("Test Review is required");return}const n=`${e.candidateId}:EA`;R(n);try{const c=await Q(m,{requirementId:e.requirementId,candidateId:e.candidateId,tallyMarks:s.tallyMarks===""?null:Number(s.tallyMarks),voiceMarks:s.voiceMarks===""?null:Number(s.voiceMarks),review:t});if(c.techResult==="FAIL"&&c.decisionRequired){r.error("Technical FAIL â€” HR decision required"),x({requirementId:e.requirementId,candidateId:e.candidateId,candidateName:e.candidateName,testType:c.testType||"TECHNICAL",stageTag:c.stageTag||"Technical Tests",failed:c.failed||null,marks:{tallyMarks:s.tallyMarks,voiceMarks:s.voiceMarks,excelMarks:s.excelMarks}}),p("");return}if(c.techResult==="PASS"){r.success("Technical PASS"),q(d=>d.filter(f=>f.candidateId!==e.candidateId));return}r.success("Saved"),await b()}catch(c){r.error((c==null?void 0:c.message)||"Submit failed")}finally{R("")}}async function _(e){if(!z){r.error("Not allowed");return}const s=E[e.candidateId]||{},t=String(s.review||"").trim();if(!t){r.error("Test Review is required");return}const n=Number(s.excelMarks);if(!Number.isFinite(n)){r.error("Enter Excel marks (0-10)");return}const c=`${e.candidateId}:EXCEL`;R(c);try{const d=await Z(m,{requirementId:e.requirementId,candidateId:e.candidateId,excelMarks:n,review:t});if(d.techResult==="FAIL"&&d.decisionRequired){r.error("Technical FAIL â€” HR decision required"),x({requirementId:e.requirementId,candidateId:e.candidateId,candidateName:e.candidateName,testType:d.testType||"TECHNICAL",stageTag:d.stageTag||"Technical Tests",failed:d.failed||null,marks:{tallyMarks:s.tallyMarks,voiceMarks:s.voiceMarks,excelMarks:s.excelMarks}}),p("");return}if(d.techResult==="PASS"){r.success("Technical PASS"),q(f=>f.filter(k=>k.candidateId!==e.candidateId));return}r.success("Excel saved"),await b()}catch(d){r.error((d==null?void 0:d.message)||"Submit failed")}finally{R("")}}return a.jsxs(X,{children:[i?a.jsxs("div",{className:"card",style:{marginBottom:12,border:"1px solid var(--gray-200)"},children:[a.jsx("div",{style:{fontWeight:800,marginBottom:6},children:"Test FAILED â€” HR decision required"}),a.jsxs("div",{className:"small",style:{color:"var(--gray-600)",marginBottom:10},children:[i.candidateName||i.candidateId," Â· ",i.stageTag]}),a.jsx("div",{className:"small",style:{marginBottom:6,fontWeight:700},children:"Remark (required only if Reject)"}),a.jsx("textarea",{value:W,onChange:e=>p(e.target.value),rows:2,style:{width:"100%"}}),a.jsxs("div",{style:{display:"flex",gap:8,marginTop:10,flexWrap:"wrap"},children:[a.jsx("button",{className:"button",type:"button",onClick:async()=>{try{await $(m,{requirementId:i.requirementId,candidateId:i.candidateId,testType:i.testType,decision:"CONTINUE",remark:String(W||"").trim(),stageTag:i.stageTag,meta:{failed:i.failed,marks:i.marks}}),r.success("Override applied (Continued)"),x(null),p(""),await b()}catch(e){r.error((e==null?void 0:e.message)||"Failed")}},disabled:!!o,children:"Continue"}),a.jsx("button",{className:"button danger",type:"button",onClick:async()=>{const e=String(W||"").trim();if(!e){r.error("Remark is required to Reject");return}try{await $(m,{requirementId:i.requirementId,candidateId:i.candidateId,testType:i.testType,decision:"REJECT",remark:e,stageTag:i.stageTag,meta:{failed:i.failed,marks:i.marks}}),J({requirementId:i.requirementId,candidateId:i.candidateId}),r.success("Rejected"),x(null),p(""),await b()}catch(s){r.error((s==null?void 0:s.message)||"Failed")}},disabled:!!o,children:"Reject"}),a.jsx("button",{className:"button",type:"button",onClick:()=>x(null),disabled:!!o,children:"Close"})]})]}):null,a.jsxs("div",{style:{marginBottom:"20px"},children:[a.jsx("h1",{className:"page-title",children:"Pending Technical Tests"}),a.jsx("p",{className:"page-subtitle",children:"EA submits Tally/Voice marks. Excel marks require permission."})]}),a.jsx("div",{className:"card",style:{marginBottom:"16px"},children:a.jsxs("div",{className:"row",style:{gap:12,alignItems:"flex-end",flexWrap:"wrap"},children:[a.jsxs("button",{className:"button",onClick:b,disabled:L,style:{display:"flex",alignItems:"center",gap:6},children:[L?a.jsx(C,{size:14}):null,"Refresh"]}),a.jsx("div",{style:{marginLeft:"auto"},children:a.jsxs("span",{className:"badge",children:[v.length," candidates"]})})]})}),L?a.jsx(G,{text:"Loading candidates..."}):a.jsxs(a.Fragment,{children:[a.jsx(O,{title:"Technical FAIL (Decision Required)",subtitle:"Candidates with Technical FAIL must be Continued/Rejected by HR",badge:S.length,variant:"card",defaultOpen:S.length>0,children:S.length===0?a.jsxs("div",{className:"empty-state",children:[a.jsx("div",{className:"empty-state-icon",children:"âœ…"}),a.jsx("div",{className:"empty-state-text",children:"No pending decisions"})]}):a.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:12},children:S.map(e=>{const s=E[e.candidateId]||{},t=Array.isArray(e.selectedTests)?e.selectedTests:[],n=t.includes("Tally"),c=t.includes("Voice"),d=t.includes("Excel"),f=`${e.candidateId}:EA`,k=`${e.candidateId}:EXCEL`,N=String(e.techResult||"").toUpperCase(),I=N==="FAIL"&&A(e,"TECHNICAL"),T=N==="FAIL"&&!I;return a.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:a.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:16,flexWrap:"wrap"},children:[a.jsxs("div",{style:{flex:1,minWidth:240},children:[a.jsx("div",{style:{fontWeight:700,fontSize:"15px"},children:e.candidateName}),a.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} Â· `:"",e.jobRole," Â· ",e.mobile]}),a.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[a.jsxs("span",{className:"badge",style:{background:"var(--primary)",color:"#fff"},children:["In-person: ",e.inPersonMarks,"/10"]}),a.jsx("span",{className:"badge",style:{background:e.techResult==="PASS"?"#22c55e":e.techResult==="FAIL"?"#ef4444":"#f59e0b",color:"#fff"},children:e.techResult?String(e.techResult).toUpperCase():"PENDING"}),I?a.jsx("span",{className:"badge",style:{background:"#f59e0b",color:"#fff"},children:"Continued by HR"}):T?a.jsx("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:"Decision Required"}):null]}),a.jsxs("div",{style:{marginTop:8},children:[a.jsx("span",{className:"small",style:{fontWeight:600},children:"Selected Tests: "}),t.map(l=>a.jsx("span",{className:"badge",style:{marginRight:4},children:l},l)),t.length===0&&a.jsx("span",{className:"small",style:{color:"var(--gray-500)"},children:"None"})]}),e.updatedAt&&a.jsxs("div",{className:"small",style:{marginTop:6,color:"var(--gray-500)"},children:["Last update: ",V(e.updatedAt)]})]}),a.jsxs("div",{style:{display:"grid",gap:12,minWidth:300},children:[a.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap"},children:[n&&a.jsxs("div",{children:[a.jsx("label",{className:"small",style:{fontWeight:600,display:"block",marginBottom:4},children:"Tally"}),a.jsx("input",{style:{width:80},value:s.tallyMarks??"",onChange:l=>g(e.candidateId,"tallyMarks",l.target.value),placeholder:"0-10"})]}),c&&a.jsxs("div",{children:[a.jsx("label",{className:"small",style:{fontWeight:600,display:"block",marginBottom:4},children:"Voice"}),a.jsx("input",{style:{width:80},value:s.voiceMarks??"",onChange:l=>g(e.candidateId,"voiceMarks",l.target.value),placeholder:"0-10"})]}),d&&j&&a.jsxs("div",{children:[a.jsxs("label",{className:"small",style:{fontWeight:600,display:"block",marginBottom:4},children:["Excel ",!h&&"ðŸ”’"]}),a.jsx("input",{style:{width:80,opacity:h?1:.5},value:s.excelMarks??"",onChange:l=>g(e.candidateId,"excelMarks",l.target.value),disabled:!h,placeholder:"0-10"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"small",style:{fontWeight:700,display:"block",marginBottom:4},children:"Test Review (Required)"}),a.jsx("textarea",{value:s.review??"",onChange:l=>g(e.candidateId,"review",l.target.value),rows:2,placeholder:"Write review for tests",style:{width:"100%"}})]}),T?a.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:a.jsx("button",{className:"button",type:"button",onClick:()=>{x({requirementId:e.requirementId,candidateId:e.candidateId,candidateName:e.candidateName,testType:"TECHNICAL",stageTag:"Technical Tests",failed:null,marks:{tallyMarks:e.tallyMarks,voiceMarks:e.voiceMarks,excelMarks:e.excelMarks}}),p("")},disabled:!!o,children:"Decide (Continue/Reject)"})}):null,a.jsxs("div",{className:"action-grid",children:[a.jsxs("button",{className:"button primary",type:"button",onClick:()=>H(e),disabled:!w||!!o,children:[o===f?a.jsx(C,{size:14}):null,"Submit EA Marks"]}),d&&j&&a.jsxs("button",{className:"button",type:"button",onClick:()=>_(e),disabled:!h||!!o,children:[o===k?a.jsx(C,{size:14}):null,"Submit Excel"]})]})]})]})},e.candidateId)})})}),a.jsx("div",{style:{height:16}}),a.jsx(O,{title:"Pending Technical Tests",subtitle:"Enter marks for Tally, Voice, and Excel tests",badge:D.length,variant:"card",defaultOpen:!0,children:D.length===0?a.jsxs("div",{className:"empty-state",children:[a.jsx("div",{className:"empty-state-icon",children:"âœ…"}),a.jsx("div",{className:"empty-state-text",children:"No pending technical tests"})]}):a.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:12},children:D.map(e=>{const s=E[e.candidateId]||{},t=Array.isArray(e.selectedTests)?e.selectedTests:[],n=t.includes("Tally"),c=t.includes("Voice"),d=t.includes("Excel"),f=`${e.candidateId}:EA`,k=`${e.candidateId}:EXCEL`,N=String(e.techResult||"").toUpperCase(),I=N==="FAIL"&&A(e,"TECHNICAL"),T=N==="FAIL"&&!I;return a.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:a.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:16,flexWrap:"wrap"},children:[a.jsxs("div",{style:{flex:1,minWidth:240},children:[a.jsx("div",{style:{fontWeight:700,fontSize:"15px"},children:e.candidateName}),a.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} Â· `:"",e.jobRole," Â· ",e.mobile]}),a.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[a.jsxs("span",{className:"badge",style:{background:"var(--primary)",color:"#fff"},children:["In-person: ",e.inPersonMarks,"/10"]}),a.jsx("span",{className:"badge",style:{background:e.techResult==="PASS"?"#22c55e":e.techResult==="FAIL"?"#ef4444":"#f59e0b",color:"#fff"},children:e.techResult?String(e.techResult).toUpperCase():"PENDING"}),I?a.jsx("span",{className:"badge",style:{background:"#f59e0b",color:"#fff"},children:"Continued by HR"}):T?a.jsx("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:"Decision Required"}):null]}),a.jsxs("div",{style:{marginTop:8},children:[a.jsx("span",{className:"small",style:{fontWeight:600},children:"Selected Tests: "}),t.map(l=>a.jsx("span",{className:"badge",style:{marginRight:4},children:l},l)),t.length===0&&a.jsx("span",{className:"small",style:{color:"var(--gray-500)"},children:"None"})]}),e.updatedAt&&a.jsxs("div",{className:"small",style:{marginTop:6,color:"var(--gray-500)"},children:["Last update: ",V(e.updatedAt)]})]}),a.jsxs("div",{style:{display:"grid",gap:12,minWidth:300},children:[a.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap"},children:[n&&a.jsxs("div",{children:[a.jsx("label",{className:"small",style:{fontWeight:600,display:"block",marginBottom:4},children:"Tally"}),a.jsx("input",{style:{width:80},value:s.tallyMarks??"",onChange:l=>g(e.candidateId,"tallyMarks",l.target.value),placeholder:"0-10"})]}),c&&a.jsxs("div",{children:[a.jsx("label",{className:"small",style:{fontWeight:600,display:"block",marginBottom:4},children:"Voice"}),a.jsx("input",{style:{width:80},value:s.voiceMarks??"",onChange:l=>g(e.candidateId,"voiceMarks",l.target.value),placeholder:"0-10"})]}),d&&j&&a.jsxs("div",{children:[a.jsxs("label",{className:"small",style:{fontWeight:600,display:"block",marginBottom:4},children:["Excel ",!h&&"ðŸ”’"]}),a.jsx("input",{style:{width:80,opacity:h?1:.5},value:s.excelMarks??"",onChange:l=>g(e.candidateId,"excelMarks",l.target.value),disabled:!h,placeholder:"0-10"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"small",style:{fontWeight:700,display:"block",marginBottom:4},children:"Test Review (Required)"}),a.jsx("textarea",{value:s.review??"",onChange:l=>g(e.candidateId,"review",l.target.value),rows:2,placeholder:"Write review for tests",style:{width:"100%"}})]}),T?a.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:a.jsx("button",{className:"button",type:"button",onClick:()=>{x({requirementId:e.requirementId,candidateId:e.candidateId,candidateName:e.candidateName,testType:"TECHNICAL",stageTag:"Technical Tests",failed:null,marks:{tallyMarks:e.tallyMarks,voiceMarks:e.voiceMarks,excelMarks:e.excelMarks}}),p("")},disabled:!!o,children:"Decide (Continue/Reject)"})}):null,a.jsxs("div",{className:"action-grid",children:[a.jsxs("button",{className:"button primary",type:"button",onClick:()=>H(e),disabled:!w||!!o,children:[o===f?a.jsx(C,{size:14}):null,"Submit EA Marks"]}),d&&j&&a.jsxs("button",{className:"button",type:"button",onClick:()=>_(e),disabled:!h||!!o,children:[o===k?a.jsx(C,{size:14}):null,"Submit Excel"]})]})]})]})},e.candidateId)})})})]})]})}export{se as EaTechPage};
