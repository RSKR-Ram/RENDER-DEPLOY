import{a as Z,r as p,j as t,A as ee,S as h,M as te,R as ae,n as s,V as w,U as re,W as ne,X as se,Y as P}from"./index-Dn7xk2-6.js";import{C as $}from"./Collapsible-BtIsWir-.js";function ie(){const d=new Date,I=d.getFullYear(),u=String(d.getMonth()+1).padStart(2,"0"),f=String(d.getDate()).padStart(2,"0");return`${I}-${u}-${f}`}function C(d){if(!d)return"";const I=d instanceof Date?d:new Date(d);return Number.isNaN(I.getTime())?String(d):I.toLocaleString()}function de(d,I){const u=I?new Date(I):null,f=g=>String(g).padStart(2,"0"),j=u&&!Number.isNaN(u.getTime())?`${u.getFullYear()}-${f(u.getMonth()+1)}-${f(u.getDate())}T${f(u.getHours())}:${f(u.getMinutes())}`:"",R=window.prompt(d+" (YYYY-MM-DDTHH:mm):",j);if(R==null)return null;const l=String(R).trim();if(!l)return"";const N=new Date(l);return Number.isNaN(N.getTime())?"INVALID":N.toISOString()}function ce(){const{token:d,role:I,legacyRole:u,canPortal:f,canAction:j}=Z();function R(e,a){const r=typeof f=="function"?f(e):null;if(r===!0||r===!1)return r;const n=String(u||I||"").toUpperCase();return Array.isArray(a)?a.includes(n):!1}function l(e,a){const r=typeof j=="function"?j(e):null;if(r===!0||r===!1)return r;const n=String(u||I||"").toUpperCase();return Array.isArray(a)?a.includes(n):!1}const N=R("PORTAL_HR_PREINTERVIEW",["HR","ADMIN"]),[g,H]=p.useState(ie()),[y,U]=p.useState("ALL"),[b,D]=p.useState(!1),[E,x]=p.useState([]),[L,q]=p.useState({}),[M,O]=p.useState({}),[m,o]=p.useState("");function _(e,a){try{const r=JSON.parse(String((e==null?void 0:e.testDecisionsJson)||"{}")),n=r==null?void 0:r[a];return String((n==null?void 0:n.decision)||"").toUpperCase()==="CONTINUE"}catch{return!1}}const W=p.useMemo(()=>{const e=Array.from(new Set(E.map(a=>a.jobRole).filter(Boolean)));return e.sort((a,r)=>String(a).localeCompare(String(r))),["ALL",...e]},[E]);async function A(e,a){if(N&&l("PRECALL_LIST",["HR","ADMIN"])){D(!0);try{const i=(await ae(d,{date:e,jobRole:a&&a!=="ALL"?a:""})).items??[];x(i.filter(c=>{if(!c.preCallAt)return!1;const S=String(c.onlineTestResult||"").toUpperCase();return S?!(S==="PASS"||S==="FAIL"&&_(c,"ONLINE_TEST")):!0}))}catch(r){s.error((r==null?void 0:r.message)||"Failed to load")}finally{D(!1)}}}p.useEffect(()=>{A(g,y)},[g,y,N]);const T=p.useMemo(()=>y==="ALL"?E:E.filter(e=>e.jobRole===y),[E,y]),v=p.useMemo(()=>T.filter(e=>String(e.preInterviewStatus||"").toUpperCase()!=="APPEARED"),[T]),k=p.useMemo(()=>T.filter(e=>String(e.preInterviewStatus||"").toUpperCase()==="APPEARED"),[T]);async function F(e){if(!l("PREINTERVIEW_STATUS",["HR","ADMIN"])){s.error("Not allowed");return}const a=`${e.candidateId}:APPEARED`;o(a);try{const r=await w(d,{requirementId:e.requirementId,candidateId:e.candidateId,op:"APPEARED"});s.success("Marked Appeared"),x(n=>n.map(i=>i.candidateId===e.candidateId?{...i,preInterviewStatus:r.preInterviewStatus||"APPEARED"}:i))}catch(r){s.error((r==null?void 0:r.message)||"Failed")}finally{o("")}}async function V(e){if(!l("PREINTERVIEW_STATUS",["HR","ADMIN"])){s.error("Not allowed");return}const a=de("New pre-interview date/time",e.preCallAt);if(a==null)return;if(a==="INVALID"){s.error("Invalid date/time");return}if(a===""){s.error("Date/time required");return}const r=`${e.candidateId}:RESCHEDULE`;o(r);try{const n=await w(d,{requirementId:e.requirementId,candidateId:e.candidateId,op:"RESCHEDULE",preInterviewAt:a});s.success("Rescheduled"),x(i=>i.map(c=>c.candidateId===e.candidateId?{...c,preCallAt:n.preInterviewAt||a}:c))}catch(n){s.error((n==null?void 0:n.message)||"Failed")}finally{o("")}}async function K(e){if(!l("PREINTERVIEW_STATUS",["HR","ADMIN"])){s.error("Not allowed");return}const a=window.prompt("Reject remark (required):");if(a==null)return;if(!String(a).trim()){s.error("Remark required");return}const r=`${e.candidateId}:REJECT`;o(r);try{await w(d,{requirementId:e.requirementId,candidateId:e.candidateId,op:"REJECT",remark:String(a).trim()}),re({requirementId:e.requirementId,candidateId:e.candidateId}),s.success("Rejected"),x(n=>n.filter(i=>i.candidateId!==e.candidateId))}catch(n){s.error((n==null?void 0:n.message)||"Failed")}finally{o("")}}async function z(e){if(!l("PREINTERVIEW_MARKS_SAVE",["HR","ADMIN"])){s.error("Not allowed");return}const a=L[e.candidateId];if(a==null||String(a).trim()===""){s.error("Enter marks");return}const r=`${e.candidateId}:MARKS`;o(r);try{const n=await ne(d,{requirementId:e.requirementId,candidateId:e.candidateId,marks:String(a).trim()});s.success("Marks saved"),x(i=>i.map(c=>c.candidateId===e.candidateId?{...c,preInterviewMarks:n.preInterviewMarks}:c))}catch(n){s.error((n==null?void 0:n.message)||"Failed")}finally{o("")}}async function B(e){if(!l("TEST_LINK_CREATE",["HR","ADMIN"])){s.error("Not allowed");return}const a=`${e.candidateId}:LINK`;o(a);try{const r=await se(d,{requirementId:e.requirementId,candidateId:e.candidateId}),n=`${window.location.origin}${window.location.pathname}#/test?token=${encodeURIComponent(r.token)}`;O(i=>({...i,[e.candidateId]:{url:n,token:r.token,expiresAt:r.expiresAt}})),s.success("Test link created")}catch(r){s.error((r==null?void 0:r.message)||"Failed")}finally{o("")}}async function J(e){if(!l("TEST_FAIL_DECIDE",["HR","ADMIN"])){s.error("Not allowed");return}const a=`${e.candidateId}:ONLINE_CONTINUE`;o(a);try{await P(d,{requirementId:e.requirementId,candidateId:e.candidateId,testType:"ONLINE_TEST",decision:"CONTINUE",remark:"",stageTag:"Online Test",meta:{marks:{score:e.onlineTestScore,result:e.onlineTestResult}}}),s.success("Continued by HR"),await A(g,y)}catch(r){s.error((r==null?void 0:r.message)||"Failed")}finally{o("")}}async function Y(e){if(!l("TEST_FAIL_DECIDE",["HR","ADMIN"])){s.error("Not allowed");return}const a=window.prompt("Remark (required):","");if(a==null)return;const r=String(a||"").trim();if(!r){s.error("Remark is required");return}const n=`${e.candidateId}:ONLINE_REJECT`;o(n);try{await P(d,{requirementId:e.requirementId,candidateId:e.candidateId,testType:"ONLINE_TEST",decision:"REJECT",remark:r,stageTag:"Online Test",meta:{marks:{score:e.onlineTestScore,result:e.onlineTestResult}}}),s.success("Rejected"),await A(g,y)}catch(i){s.error((i==null?void 0:i.message)||"Failed")}finally{o("")}}async function G(e){var r;const a=(r=M[e.candidateId])==null?void 0:r.url;if(a)try{await navigator.clipboard.writeText(a),s.success("Copied")}catch{s.error("Copy failed")}}const X=()=>A(g,y);return t.jsxs(ee,{children:[N?null:t.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[t.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),t.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You dont have access to Preinterview portal."})]}),t.jsxs("div",{style:{marginBottom:"20px"},children:[t.jsx("h1",{className:"page-title",children:"Pre-interview Scheduled"}),t.jsx("p",{className:"page-subtitle",children:"Manage scheduled pre-interviews and enter marks"})]}),t.jsxs("div",{className:"card",style:{marginBottom:"16px"},children:[t.jsxs("div",{className:"row",style:{gap:12,alignItems:"flex-end",flexWrap:"wrap"},children:[t.jsxs("div",{children:[t.jsx("div",{className:"small",style:{marginBottom:4},children:"Walk-in Date"}),t.jsx("input",{type:"date",value:g,onChange:e=>H(e.target.value)})]}),t.jsxs("button",{className:"button",onClick:X,disabled:b,style:{display:"flex",alignItems:"center",gap:6},children:[b?t.jsx(h,{size:14}):null,"Refresh"]}),t.jsx("div",{style:{marginLeft:"auto"},children:t.jsxs("span",{className:"badge",children:[T.length," candidates"]})})]}),t.jsx("div",{style:{height:12}}),t.jsx("div",{className:"tabs",children:W.map(e=>t.jsx("button",{className:["tab",y===e?"active":""].join(" "),onClick:()=>U(e),type:"button",children:e},e))})]}),b?t.jsx(te,{text:"Loading candidates..."}):t.jsxs(t.Fragment,{children:[t.jsx($,{title:"Scheduled Candidates",subtitle:"Candidates with pre-interview date/time fixed (from Precall 'Call Done')",badge:v.length,variant:"card",defaultOpen:!0,children:v.length===0?t.jsxs("div",{className:"empty-state",children:[t.jsx("div",{className:"empty-state-icon",children:""}),t.jsx("div",{className:"empty-state-text",children:"No scheduled candidates"})]}):t.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:v.map(e=>{const a=`${e.candidateId}:APPEARED`,r=`${e.candidateId}:RESCHEDULE`,n=`${e.candidateId}:REJECT`;return t.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:t.jsxs("div",{className:"row",style:{alignItems:"center",flexWrap:"wrap",gap:12},children:[t.jsxs("div",{style:{flex:1,minWidth:200},children:[t.jsx("div",{style:{fontWeight:700,fontSize:"15px"},children:e.candidateName}),t.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} 路 `:"",e.jobRole," 路 ",e.mobile]}),t.jsx("div",{style:{marginTop:6},children:t.jsxs("span",{className:"badge",style:{background:"var(--primary)",color:"#fff"},children:[" ",C(e.preCallAt)]})})]}),t.jsxs("div",{className:"action-grid",children:[t.jsxs("button",{className:"button primary",type:"button",onClick:()=>F(e),disabled:!!m||!l("PREINTERVIEW_STATUS",["HR","ADMIN"]),children:[m===a?t.jsx(h,{size:14}):null,"Appeared"]}),t.jsxs("button",{className:"button",type:"button",onClick:()=>V(e),disabled:!!m||!l("PREINTERVIEW_STATUS",["HR","ADMIN"]),children:[m===r?t.jsx(h,{size:14}):null,"Reschedule"]}),t.jsxs("button",{className:"button danger",type:"button",onClick:()=>K(e),disabled:!!m||!l("PREINTERVIEW_STATUS",["HR","ADMIN"]),children:[m===n?t.jsx(h,{size:14}):null,"Reject"]})]})]})},e.candidateId)})})}),t.jsx("div",{style:{height:16}}),t.jsx($,{title:"Pre-interview Marks",subtitle:"Only candidates marked Appeared",badge:k.length,variant:"card",defaultOpen:!0,children:k.length===0?t.jsxs("div",{className:"empty-state",children:[t.jsx("div",{className:"empty-state-icon",children:""}),t.jsx("div",{className:"empty-state-text",children:"No candidates ready for marks"})]}):t.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:k.map(e=>{const a=M[e.candidateId],r=`${e.candidateId}:MARKS`,n=`${e.candidateId}:LINK`,i=String(e.onlineTestResult||"").toUpperCase(),c=i==="FAIL"&&_(e,"ONLINE_TEST");return t.jsxs("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:[t.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flexWrap:"wrap"},children:[t.jsxs("div",{style:{minWidth:240},children:[t.jsx("div",{style:{fontWeight:700,fontSize:"15px"},children:e.candidateName}),t.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} 路 `:"",e.jobRole," 路 ",e.mobile]}),t.jsx("div",{style:{marginTop:6},children:t.jsxs("span",{className:"badge",style:{background:"var(--primary)",color:"#fff"},children:[" ",C(e.preCallAt)]})})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",flex:1},children:[t.jsx("input",{style:{width:100},placeholder:"Marks",value:L[e.candidateId]??e.preInterviewMarks??"",onChange:S=>q(Q=>({...Q,[e.candidateId]:S.target.value}))}),t.jsxs("button",{className:"button",type:"button",onClick:()=>z(e),disabled:!!m||!l("PREINTERVIEW_MARKS_SAVE",["HR","ADMIN"]),children:[m===r?t.jsx(h,{size:14}):null,"Save"]}),t.jsxs("button",{className:"button primary",type:"button",onClick:()=>B(e),disabled:!!m||!l("TEST_LINK_CREATE",["HR","ADMIN"])||!!String(e.onlineTestSubmittedAt||"").trim(),children:[m===n?t.jsx(h,{size:14}):null,"Generate Link"]}),a!=null&&a.url?t.jsx("button",{className:"button",type:"button",onClick:()=>G(e),children:" Copy"}):null]})]}),a!=null&&a.url?t.jsxs("div",{style:{marginTop:12,padding:"10px 12px",background:"var(--gray-100)",borderRadius:"var(--radius)",fontSize:"13px",wordBreak:"break-all"},children:[t.jsx("strong",{children:"Test Link:"})," ",a.url,a.expiresAt?t.jsxs("span",{style:{color:"var(--gray-500)"},children:[" (expires: ",C(a.expiresAt),")"]}):""]}):null,i?t.jsxs("div",{style:{marginTop:12,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[t.jsxs("span",{className:"badge",style:{background:i==="PASS"?"#22c55e":"#ef4444",color:"#fff"},children:["Online Test: ",i,e.onlineTestScore!==""&&e.onlineTestScore!=null?` (${e.onlineTestScore}/10)`:""]}),i==="FAIL"?c?t.jsx("span",{className:"badge",style:{background:"#f59e0b",color:"#fff"},children:"Continued by HR"}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:"Decision Required"}),t.jsx("button",{className:"button",type:"button",onClick:()=>J(e),disabled:!!m||!l("TEST_FAIL_DECIDE",["HR","ADMIN"]),children:"Continue"}),t.jsx("button",{className:"button danger",type:"button",onClick:()=>Y(e),disabled:!!m||!l("TEST_FAIL_DECIDE",["HR","ADMIN"]),children:"Reject"})]}):null]}):null]},e.candidateId)})})})]})]})}export{ce as PreinterviewPage};
